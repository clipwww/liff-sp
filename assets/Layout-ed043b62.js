import{m as u,h as o,n as p}from"./index-71d8585f.js";import{m as n}from"./index-899719e6.js";import{g as m,d as g,u as v,e as d,f as y,h as _,i as b,j as L,k as w,m as P,n as k}from"./turnip.svc-f76d0fd1.js";import"./acnh.svc-a593798b.js";import"./firebase-b7fcb020.js";const a=n.getWeekStart(),f=n.getWeekdays(),h={};f.forEach(t=>{h[t.id]={am:"",pm:""}});const $={props:{value:{type:Boolean,required:!0}},data(){return{buyDay:a.format("M/D (ddd)"),weekdays:f,sellPrice:h,buyPrice:"",islandName:"",isLoading:!1,showBtn:!1}},computed:{...u({isLoggedIn:"isLoggedIn",profile:"profile"}),isOpen:{get(){return this.value},set(t){this.$emit("input",t)}}},watch:{isOpen:{immediate:!0,handler(t){t&&this.getTurnipPrice()}}},methods:{async getTurnipPrice(){this.isLoading=!0;const t=await m(this.profile.userId,a);if(t){const{buyPrice:e,sellPrice:s}=t;this.buyPrice=e,this.sellPrice=s}this.isLoading=!1,this.focusField()},async updateTurnipPrice(){try{this.isLoading=!0,await Promise.all([g(this.profile.userId,a,{buyPrice:this.buyPrice,sellPrice:this.sellPrice}),this.updateProfileByUserId()]),this.$notify({type:"success",message:"儲存成功"}),this.$emit("success"),this.isOpen=!1}catch(t){}finally{this.isLoading=!1}},async updateProfileByUserId(){try{await v(this.profile.userId,this.profile)}catch(t){}},focusField(){this.$nextTick(()=>{var t,e;try{if(o().isSame(a,"day"))return;let s=0;const i=o(),r=i.weekday(),l=i.locale("en-us").format("a");s=r*2,l==="am"&&(s-=1),(e=(t=this.$refs.popup)==null?void 0:t.$el)==null||e.scrollTo(0,50*s)}catch(s){}})}}};var I=function(){var e=this,s=e._self._c;return s("van-popup",{ref:"popup",style:{height:"90%"},attrs:{position:"bottom",closeable:"","lazy-render":""},on:{opened:function(i){e.showBtn=!0},close:function(i){e.showBtn=!1}},model:{value:e.isOpen,callback:function(i){e.isOpen=i},expression:"isOpen"}},[s("div",{staticClass:"padding-t-30"},[s("div",{staticClass:"editor"},[s("van-cell-group",[s("div",{staticClass:"fs-20",attrs:{slot:"title"},slot:"title"},[e._v(" "+e._s(e.buyDay)+" ")]),s("van-field",{attrs:{type:"digit",label:"買入價格",placeholder:"請輸入週日買入價格",disabled:e.isLoading},model:{value:e.buyPrice,callback:function(i){e.buyPrice=i},expression:"buyPrice"}})],1),e._l(e.weekdays,function(i){return s("van-cell-group",{key:i.id,attrs:{title:i.label}},[s("van-field",{ref:`${i.id}am`,refInFor:!0,attrs:{type:"digit",label:"上午賣價",placeholder:`請輸入 ${i.label} 上午賣價`,disabled:e.isLoading},model:{value:e.sellPrice[i.id].am,callback:function(r){e.$set(e.sellPrice[i.id],"am",r)},expression:"sellPrice[item.id].am"}}),s("van-field",{ref:`${i.id}pm`,refInFor:!0,attrs:{type:"digit",label:"下午賣價",placeholder:`請輸入 ${i.label} 下午賣價`,disabled:e.isLoading},model:{value:e.sellPrice[i.id].pm,callback:function(r){e.$set(e.sellPrice[i.id],"pm",r)},expression:"sellPrice[item.id].pm"}})],1)}),s("div",{staticClass:"fixed-btn"},[s("van-button",{directives:[{name:"show",rawName:"v-show",value:e.showBtn,expression:"showBtn"}],attrs:{button:"",type:"primary",round:"",block:"",disabled:e.isLoading},on:{click:e.updateTurnipPrice}},[e._v(" 送出 ")])],1)],2)])])},x=[],B=p($,I,x,!1,null,"cf672e40",null,null);const U=B.exports;const E=n.getWeekdays(),c=n.getWeekStart(),T={components:{TurnipEditorPopup:U},data(){return{weekdays:E,showEditor:!1,groupList:[],priceList:[],userList:[],histories:[],isLoading:!1}},computed:{...u({isLoggedIn:"isLoggedIn",profile:"profile"})},watch:{profile:{immediate:!0,handler(t){!t||!t.userId||(d(),y(t.userId,e=>{this.histories=e.filter(s=>!o().isSame(s.id,"week")).sort((s,i)=>o(s.id).isBefore(i.id)?1:-1)}))}}},created(){this.initListener()},beforeUnmount(){_(),b(),L(c),d()},methods:{async initListener(){this.isLoading=!0,await Promise.all([w(t=>{this.groupList=t}),P(c,t=>{this.priceList=t}),k(t=>{this.userList=t})]),this.isLoading=!1},openEditor(){if(!this.isLoggedIn){this.$toast.fail({message:"必須要登入才可以使用唷"});return}this.showEditor=!0},login(){window.liff.login({redirectUri:window.location.href})}}};var C=function(){var e=this,s=e._self._c;return s("div",{staticClass:"with-safe-area-inset-bottom"},[s("van-notice-bar",{attrs:{background:"#ecf9ff","left-icon":"volume-o"}},[s("span",{staticClass:"margin-r-15"},[e._v(e._s(e.weekdays[0].label)+" ~ "+e._s(e.weekdays[e.weekdays.length-1].label))]),s("span",[e._v("南北菜蟲一起串連")])]),e.isLoggedIn?e.isLoading?s("div",[s("van-skeleton",{staticClass:"padding-bt-15",attrs:{title:"",row:6}})],1):s("div",[s("router-view",{attrs:{"group-list":e.groupList,"price-list":e.priceList,"user-list":e.userList,histories:e.histories}})],1):s("div",{staticClass:"padding-a-10"},[s("van-button",{attrs:{type:"primary",size:"large",block:""},on:{click:e.login}},[e._v(" 請先登入 ")])],1),s("TurnipEditorPopup",{model:{value:e.showEditor,callback:function(i){e.showEditor=i},expression:"showEditor"}}),s("van-tabbar",{attrs:{fixed:"",route:"","safe-area-inset-bottom":""}},[s("van-tabbar-item",{attrs:{icon:"chart-trending-o",to:{name:"TurnipDashboard"}}},[e._v(" 儀表板 ")]),s("van-tabbar-item",{attrs:{icon:"friends",to:{name:"TurnipGroup"}}},[e._v(" 群組列表 ")]),s("van-tabbar-item",{attrs:{icon:"edit"},on:{click:e.openEditor}},[e._v(" 紀錄本週價格 ")])],1)],1)},F=[],O=p(T,C,F,!1,null,"9efb8fde",null,null);const H=O.exports;export{H as default};
