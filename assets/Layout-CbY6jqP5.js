import{_ as U,j as y,M as B,r,o as d,e as k,w as n,g as c,a as o,t as v,c as m,F as x,d as S,h as D,b as g,v as O}from"./index-D_e8FN_z.js";import"./acnh.svc-Dirrrzgx.js";import{a as F,d as G,g as N,e as W,f as j,h as z,i as H,j as M,k as q,m as P,n as A}from"./turnip.svc-Dre4WWUB.js";import{m as b}from"./index-C0sn0UrP.js";import"./firebase-LKY1-RY1.js";const _=b.getWeekStart(),V=b.getWeekdays(),T={};V.forEach(e=>{T[e.id]={am:"",pm:""}});const J={props:{value:{type:Boolean,required:!0}},emits:["input","success"],data(){return{buyDay:_.format("M/D (ddd)"),weekdays:V,sellPrice:T,buyPrice:"",islandName:"",isLoading:!1,showBtn:!1}},computed:{...B({isLoggedIn:"isLoggedIn",profile:"profile"}),isOpen:{get(){return this.value},set(e){this.$emit("input",e)}}},watch:{isOpen:{immediate:!0,handler(e){e&&this.getTurnipPrice()}}},methods:{async getTurnipPrice(){this.isLoading=!0;const e=await N(this.profile.userId,_);if(e){const{buyPrice:s,sellPrice:l}=e;this.buyPrice=s,this.sellPrice=l}this.isLoading=!1,this.focusField()},async updateTurnipPrice(){try{this.isLoading=!0,await Promise.all([G(this.profile.userId,_,{buyPrice:this.buyPrice,sellPrice:this.sellPrice}),this.updateProfileByUserId()]),this.$notify({type:"success",message:"儲存成功"}),this.$emit("success"),this.isOpen=!1}catch(e){}finally{this.isLoading=!1}},async updateProfileByUserId(){try{await F(this.profile.userId,this.profile)}catch(e){}},focusField(){this.$nextTick(()=>{try{if(y().isSame(_,"day"))return;let e=0;const s=y(),l=s.weekday(),u=s.locale("en-us").format("a");e=l*2,u==="am"&&(e-=1),this.$refs.popup?.$el?.scrollTo(0,50*e)}catch(e){}})}}},K={class:"padding-t-30"},Q={class:"editor"},R={class:"fs-20"},X={class:"fixed-btn"};function Y(e,s,l,u,i,p){const f=r("van-field"),h=r("van-cell-group"),w=r("van-button"),L=r("van-popup");return d(),k(L,{ref:"popup",show:p.isOpen,"onUpdate:show":s[1]||(s[1]=t=>p.isOpen=t),position:"bottom",closeable:"","lazy-render":"",style:{height:"90%"},onOpened:s[2]||(s[2]=t=>i.showBtn=!0),onClose:s[3]||(s[3]=t=>i.showBtn=!1)},{default:n(()=>[c("div",K,[c("div",Q,[o(h,null,{title:n(()=>[c("div",R,v(i.buyDay),1)]),default:n(()=>[o(f,{modelValue:i.buyPrice,"onUpdate:modelValue":s[0]||(s[0]=t=>i.buyPrice=t),type:"digit",label:"買入價格",placeholder:"請輸入週日買入價格",disabled:i.isLoading},null,8,["modelValue","disabled"])]),_:1}),(d(!0),m(x,null,S(i.weekdays,t=>(d(),k(h,{key:t.id,title:t.label},{default:n(()=>[o(f,{ref_for:!0,ref:`${t.id}am`,modelValue:i.sellPrice[t.id].am,"onUpdate:modelValue":a=>i.sellPrice[t.id].am=a,type:"digit",label:"上午賣價",placeholder:`請輸入 ${t.label} 上午賣價`,disabled:i.isLoading},null,8,["modelValue","onUpdate:modelValue","placeholder","disabled"]),o(f,{ref_for:!0,ref:`${t.id}pm`,modelValue:i.sellPrice[t.id].pm,"onUpdate:modelValue":a=>i.sellPrice[t.id].pm=a,type:"digit",label:"下午賣價",placeholder:`請輸入 ${t.label} 下午賣價`,disabled:i.isLoading},null,8,["modelValue","onUpdate:modelValue","placeholder","disabled"])]),_:2},1032,["title"]))),128)),c("div",X,[D(o(w,{button:"",type:"primary",round:"",block:"",disabled:i.isLoading,onClick:p.updateTurnipPrice},{default:n(()=>[...s[4]||(s[4]=[g(" 送出 ",-1)])]),_:1},8,["disabled","onClick"]),[[O,i.showBtn]])])])])]),_:1},8,["show"])}const Z=U(J,[["render",Y],["__scopeId","data-v-9557d950"]]),$=b.getWeekdays(),I=b.getWeekStart(),ee={components:{TurnipEditorPopup:Z},data(){return{weekdays:$,showEditor:!1,groupList:[],priceList:[],userList:[],histories:[],isLoading:!1}},computed:{...B({isLoggedIn:"isLoggedIn",profile:"profile"})},watch:{profile:{immediate:!0,handler(e){!e||!e.userId||(P(),A(e.userId,s=>{this.histories=s.filter(l=>!y().isSame(l.id,"week")).sort((l,u)=>y(l.id).isBefore(u.id)?1:-1)}))}}},created(){this.initListener()},beforeUnmount(){H(),M(),q(I),P()},methods:{async initListener(){this.isLoading=!0,await Promise.all([W(e=>{this.groupList=e}),j(I,e=>{this.priceList=e}),z(e=>{this.userList=e})]),this.isLoading=!1},openEditor(){if(!this.isLoggedIn){this.$toast.fail({message:"必須要登入才可以使用唷"});return}this.showEditor=!0},login(){window.liff.login({redirectUri:window.location.href})}}},se={class:"with-safe-area-inset-bottom"},ie={class:"margin-r-15"},te={key:0,class:"padding-a-10"},oe={key:1},re={key:2};function ne(e,s,l,u,i,p){const f=r("van-notice-bar"),h=r("van-button"),w=r("van-skeleton"),L=r("router-view"),t=r("TurnipEditorPopup"),a=r("van-tabbar-item"),E=r("van-tabbar");return d(),m("div",se,[o(f,{background:"#ecf9ff","left-icon":"volume-o"},{default:n(()=>[c("span",ie,v(i.weekdays[0].label)+" ~ "+v(i.weekdays[i.weekdays.length-1].label),1),s[1]||(s[1]=c("span",null,"南北菜蟲一起串連",-1))]),_:1}),e.isLoggedIn?i.isLoading?(d(),m("div",oe,[o(w,{class:"padding-bt-15",title:"",row:6})])):(d(),m("div",re,[o(L,{"group-list":i.groupList,"price-list":i.priceList,"user-list":i.userList,histories:i.histories},null,8,["group-list","price-list","user-list","histories"])])):(d(),m("div",te,[o(h,{type:"primary",size:"large",block:"",onClick:p.login},{default:n(()=>[...s[2]||(s[2]=[g(" 請先登入 ",-1)])]),_:1},8,["onClick"])])),o(t,{modelValue:i.showEditor,"onUpdate:modelValue":s[0]||(s[0]=C=>i.showEditor=C)},null,8,["modelValue"]),o(E,{fixed:"",route:"","safe-area-inset-bottom":""},{default:n(()=>[o(a,{icon:"chart-trending-o",to:{name:"TurnipDashboard"}},{default:n(()=>[...s[3]||(s[3]=[g(" 儀表板 ",-1)])]),_:1}),o(a,{icon:"friends",to:{name:"TurnipGroup"}},{default:n(()=>[...s[4]||(s[4]=[g(" 群組列表 ",-1)])]),_:1}),o(a,{icon:"edit",onClick:p.openEditor},{default:n(()=>[...s[5]||(s[5]=[g(" 紀錄本週價格 ",-1)])]),_:1},8,["onClick"])]),_:1})])}const ce=U(ee,[["render",ne]]);export{ce as default};
