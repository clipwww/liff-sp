import{_ as q,r as a,o,c as p,e as c,w as s,g as d,a as r,t as f,b as v,f as b,F as w,d as C,L as A,j as I,M as H}from"./index-COOF5Zia.js";import{_ as M}from"./isEqual-dCtc9qNw.js";import{g as O}from"./movie.svc-CBsKLzfe.js";import{m}from"./firebase-LKY1-RY1.js";import"./acnh.svc-CO3KZtm1.js";import"./isArrayLike-fL3jztxv.js";import"./_getTag-CGruzcuc.js";const U={metaInfo(){return{title:this.$route.query.title||this.movieInfo.name}},data(){return{movieInfo:{},theaterList:[],cacheTheaterList:[],favoriteList:[],cityId:this.$route.query.cityId||window.localStorage.getItem("cityId")||"",isEmpty:!1}},computed:{...H({isLoggedIn:"isLoggedIn",profile:"profile"}),citys(){return this.movieInfo?.citys??[]},movieId(){return this.$route.params.id},isFavorite(){return!!this.favoriteList.find(e=>e.id===this.movieInfo.id)},posterSrc(){return!this.movieInfo.poster||this.movieInfo.poster.includes("l10l010l3322l1")?"https://via.placeholder.com/250x370?text=404":this.movieInfo.poster}},watch:{citys(e){e.length&&(e.find(h=>h.id===this.cityId)||(this.cityId=e[0].id))},cityId:{immediate:!0,handler(e,t){this.theaterList=[],m.child(`movie-${this.movieId}`).off(),m.child(`movie-${this.movieId}-${t}`).off(),m.child(`movie-${this.movieId}-${e}`).off(),m.child(`movie-${this.movieId}${e?`-${e}`:""}`).on("value",h=>{const u=h.val();u&&(this.movieInfo=u.item,this.cacheTheaterList=u.items||[],I().isSame(u.dateCreated,"day")&&(this.theaterList=this.cacheTheaterList))}),this.getMovieTimesById()}},isLoggedIn:{immediate:!0,handler(e){e&&this.getFavoriteMovies()}}},beforeUnmount(){m.child(`movie-${this.movieId}`).off(),m.child(`movie-${this.movieId}-${this.cityId}`).off()},methods:{async getMovieTimesById(){this.isEmpty=!1;const e=await O(this.movieId,this.cityId);e.success&&(e.items.length||(this.isEmpty=!0),(!M(this.cacheTheaterList,e.items)||!M(this.movieInfo,e.item))&&m.child(`movie-${this.movieId}${this.cityId?`-${this.cityId}`:""}`).set({item:e.item,items:e.items,dateCreated:+I()}),this.movieInfo=e.item,this.theaterList=e.items)},getFavoriteMovies(){this.isLoggedIn&&m.child(`favorite-movie-${this.profile.userId}`).once("value",e=>{const t=e.val();t&&t?.length&&(this.favoriteList=t||[])})},toggleFavorite(){if(!this.isLoggedIn){this.$toast.fail("必須要登入才可以使用唷！");return}this.isFavorite?this.favoriteList=this.favoriteList.filter(e=>e.id!==this.movieInfo.id):this.favoriteList.push({...this.movieInfo,dateCreated:+I()}),m.child(`favorite-movie-${this.profile.userId}`).set(this.favoriteList)},isExpired(e){return I().isAfter(I(e,"HH：mm"))},watchTrailer(){const e=this.movieInfo.trailer;window.liff.isInClient()?window.liff.openWindow({url:e,external:!0}):window.open(e)},goTheater(e){this.$router.push({name:"MovieTheaterDetails",params:{id:e.id},query:{cityId:this.cityId}})},async share(e){if(!this.isLoggedIn){this.$toast.fail("必須要登入才可以使用唷！");return}const t=[];e.versions.forEach(i=>{const n=i.times.map(_=>_.replace("：",":")),k=Math.ceil(n.length/5);t.push({type:"text",text:i.name,weight:"bold",size:"sm",margin:"md"}),t.push({type:"box",layout:"horizontal",margin:"md",contents:Array(k).fill("").map((_,y)=>({type:"box",layout:"vertical",contents:n.filter((x,g)=>g<(y+1)*5&&g>=y*5).map(x=>({type:"text",text:x,size:"xs",margin:"sm"}))}))}),t.push({type:"separator",margin:"md"})});const h=[{type:"flex",altText:"這是一個Flex Message",size:"giga",contents:{type:"bubble",header:{type:"box",layout:"vertical",contents:[{type:"text",text:this.movieInfo.name,size:"md",weight:"bold"},{type:"text",text:e.name,size:"sm",margin:"sm"}]},body:{type:"box",layout:"vertical",contents:t},action:{type:"uri",uri:`${window.location.href}?cityId=${this.cityId}`}}}];await A(h)&&this.$toast("分享成功！")}}},j={class:"padding-b-30"},G={slot:"header",class:"padding-bt-10"},P={slot:"header"},R={class:"fs-14"},W={slot:"footer"},J={class:"text-left"},K={slot:"title",class:"flex-between"},Q=["onClick"],X={slot:"desc"};function Y(e,t,h,u,i,n){const k=a("van-skeleton"),_=a("van-panel"),y=a("van-image"),x=a("van-cell"),g=a("van-col"),T=a("van-tag"),B=a("van-row"),F=a("van-button"),$=a("van-tab"),D=a("van-tabs"),N=a("van-divider"),z=a("van-card");return o(),p("div",j,[i.movieInfo.id?(o(),c(_,{key:1},{default:s(()=>[d("div",P,[r(x,{title:i.movieInfo.name,size:"large"},{default:s(()=>[r(y,{slot:"right-icon",class:"margin-l-5",width:"40",fit:"contain",src:i.movieInfo.cerImg},null,8,["src"])]),_:1},8,["title"])]),r(B,{class:"padding-lr-15",gutter:15},{default:s(()=>[r(g,{span:"7"},{default:s(()=>[r(y,{src:n.posterSrc},null,8,["src"])]),_:1}),r(g,{span:"17"},{default:s(()=>[d("p",R,f(i.movieInfo.description),1),i.movieInfo.runtime?(o(),c(T,{key:0,plain:"",class:"margin-r-5 margin-bt-5"},{default:s(()=>[v(" 片長: "+f(i.movieInfo.runtime)+" 分 ",1)]),_:1})):b("",!0),i.movieInfo.releaseDate?(o(),c(T,{key:1,plain:"",class:"margin-bt-5"},{default:s(()=>[v(" 上映日期: "+f(i.movieInfo.releaseDate),1)]),_:1})):b("",!0)]),_:1})]),_:1}),d("div",W,[d("div",J,[r(F,{icon:n.isFavorite?"like":"like-o",color:"#f48fb1",type:"default",plain:!n.isFavorite,size:"small",onClick:n.toggleFavorite},{default:s(()=>[v(f(n.isFavorite?"已收藏電影":"收藏電影"),1)]),_:1},8,["icon","plain","onClick"]),i.movieInfo.trailer?(o(),c(F,{key:0,class:"margin-l-10",type:"info",icon:"video-o",size:"small",plain:"",onClick:n.watchTrailer},{default:s(()=>[...t[1]||(t[1]=[v(" 電影預告 ",-1)])]),_:1},8,["onClick"])):b("",!0)])])]),_:1})):(o(),c(_,{key:0},{default:s(()=>[d("div",G,[r(k,{title:"",avatar:"","avatar-shape":"","avatar-size":"80",row:4})])]),_:1})),r(D,{modelValue:i.cityId,"onUpdate:modelValue":t[0]||(t[0]=l=>i.cityId=l),class:"margin-t-10"},{default:s(()=>[(o(!0),p(w,null,C(n.citys,l=>(o(),c($,{key:l.id,title:l.name,name:l.id},null,8,["title","name"]))),128))]),_:1},8,["modelValue"]),(o(!0),p(w,null,C(i.theaterList,l=>(o(),c(z,{key:l.id},{default:s(()=>[d("div",K,[d("div",{class:"fs-14",onClick:L=>n.goTheater(l)},f(l.name),9,Q),d("div",null,[r(F,{type:"info",icon:"share",size:"mini",plain:"",onClick:L=>n.share(l)},{default:s(()=>[...t[2]||(t[2]=[v(" 分享 ",-1)])]),_:1},8,["onClick"])])]),d("div",X,[(o(!0),p(w,null,C(l.versions,(L,S)=>(o(),p("div",{key:S},[r(N,{"content-position":"left"},{default:s(()=>[v(f(L.name||"數位"),1)]),_:2},1024),(o(!0),p(w,null,C(L.times,(E,V)=>(o(),c(T,{key:V,class:"margin-a-5",type:n.isExpired(E)?"default":"success",plain:""},{default:s(()=>[v(f(E),1)]),_:2},1032,["type"]))),128))]))),128))])]),_:2},1024))),128)),!i.theaterList.length&&!i.isEmpty?(o(),c(z,{key:2},{default:s(()=>[r(k,{slot:"desc",title:"",row:3})]),_:1})):b("",!0)])}const ae=q(U,[["render",Y]]);export{ae as default};
