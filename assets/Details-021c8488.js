import{m as f,h as r,s as u,n as p}from"./index-9ce14ff3.js";import{_ as h}from"./isEqual-dd5b6f94.js";import{g}from"./movie.svc-6ae5847d.js";import{m as a}from"./firebase-9126a35c.js";import"./acnh.svc-20a56244.js";import"./_getTag-5c2352f3.js";import"./isArrayLike-0dd9eb15.js";const y={metaInfo(){return{title:this.$route.query.title||this.movieInfo.name}},data(){return{movieInfo:{},theaterList:[],cacheTheaterList:[],favoriteList:[],cityId:this.$route.query.cityId||window.localStorage.getItem("cityId")||"",isEmpty:!1}},computed:{...f({isLoggedIn:"isLoggedIn",profile:"profile"}),citys(){var i;return((i=this.movieInfo)==null?void 0:i.citys)??[]},movieId(){return this.$route.params.id},isFavorite(){return!!this.favoriteList.find(i=>i.id===this.movieInfo.id)},posterSrc(){return!this.movieInfo.poster||this.movieInfo.poster.includes("l10l010l3322l1")?"https://via.placeholder.com/250x370?text=404":this.movieInfo.poster}},watch:{citys(i){i.length&&(i.find(e=>e.id===this.cityId)||(this.cityId=i[0].id))},cityId:{immediate:!0,handler(i,t){this.theaterList=[],a.child(`movie-${this.movieId}`).off(),a.child(`movie-${this.movieId}-${t}`).off(),a.child(`movie-${this.movieId}-${i}`).off(),a.child(`movie-${this.movieId}${i?`-${i}`:""}`).on("value",e=>{const s=e.val();s&&(this.movieInfo=s.item,this.cacheTheaterList=s.items||[],r().isSame(s.dateCreated,"day")&&(this.theaterList=this.cacheTheaterList))}),this.getMovieTimesById()}},isLoggedIn:{immediate:!0,handler(i){i&&this.getFavoriteMovies()}}},beforeUnmount(){a.child(`movie-${this.movieId}`).off(),a.child(`movie-${this.movieId}-${this.cityId}`).off()},methods:{async getMovieTimesById(){this.isEmpty=!1;const i=await g(this.movieId,this.cityId);i.success&&(i.items.length||(this.isEmpty=!0),(!h(this.cacheTheaterList,i.items)||!h(this.movieInfo,i.item))&&a.child(`movie-${this.movieId}${this.cityId?`-${this.cityId}`:""}`).set({item:i.item,items:i.items,dateCreated:+r()}),this.movieInfo=i.item,this.theaterList=i.items)},getFavoriteMovies(){this.isLoggedIn&&a.child(`favorite-movie-${this.profile.userId}`).once("value",i=>{const t=i.val();t&&(t!=null&&t.length)&&(this.favoriteList=t||[])})},toggleFavorite(){if(!this.isLoggedIn){this.$toast.fail("必須要登入才可以使用唷！");return}this.isFavorite?this.favoriteList=this.favoriteList.filter(i=>i.id!==this.movieInfo.id):this.favoriteList.push({...this.movieInfo,dateCreated:+r()}),a.child(`favorite-movie-${this.profile.userId}`).set(this.favoriteList)},isExpired(i){return r().isAfter(r(i,"HH：mm"))},watchTrailer(){const i=this.movieInfo.trailer;window.liff.isInClient()?window.liff.openWindow({url:i,external:!0}):window.open(i)},goTheater(i){this.$router.push({name:"MovieTheaterDetails",params:{id:i.id},query:{cityId:this.cityId}})},async share(i){if(!this.isLoggedIn){this.$toast.fail("必須要登入才可以使用唷！");return}const t=[];i.versions.forEach(o=>{const n=o.times.map(c=>c.replace("：",":")),l=Math.ceil(n.length/5);t.push({type:"text",text:o.name,weight:"bold",size:"sm",margin:"md"}),t.push({type:"box",layout:"horizontal",margin:"md",contents:Array(l).fill("").map((c,m)=>({type:"box",layout:"vertical",contents:n.filter((d,v)=>v<(m+1)*5&&v>=m*5).map(d=>({type:"text",text:d,size:"xs",margin:"sm"}))}))}),t.push({type:"separator",margin:"md"})});const e=[{type:"flex",altText:"這是一個Flex Message",size:"giga",contents:{type:"bubble",header:{type:"box",layout:"vertical",contents:[{type:"text",text:this.movieInfo.name,size:"md",weight:"bold"},{type:"text",text:i.name,size:"sm",margin:"sm"}]},body:{type:"box",layout:"vertical",contents:t},action:{type:"uri",uri:`${window.location.href}?cityId=${this.cityId}`}}}];await u(e)&&this.$toast("分享成功！")}}};var I=function(){var t=this,e=t._self._c;return e("div",{staticClass:"padding-b-30"},[t.movieInfo.id?e("van-panel",[e("div",{attrs:{slot:"header"},slot:"header"},[e("van-cell",{attrs:{title:t.movieInfo.name,size:"large"}},[e("van-image",{staticClass:"margin-l-5",attrs:{slot:"right-icon",width:"40",fit:"contain",src:t.movieInfo.cerImg},slot:"right-icon"})],1)],1),e("van-row",{staticClass:"padding-lr-15",attrs:{gutter:15}},[e("van-col",{attrs:{span:"7"}},[e("van-image",{attrs:{src:t.posterSrc}})],1),e("van-col",{attrs:{span:"17"}},[e("p",{staticClass:"fs-14"},[t._v(" "+t._s(t.movieInfo.description)+" ")]),t.movieInfo.runtime?e("van-tag",{staticClass:"margin-r-5 margin-bt-5",attrs:{plain:""}},[t._v(" 片長: "+t._s(t.movieInfo.runtime)+" 分 ")]):t._e(),t.movieInfo.releaseDate?e("van-tag",{staticClass:"margin-bt-5",attrs:{plain:""}},[t._v(" 上映日期: "+t._s(t.movieInfo.releaseDate)+" ")]):t._e()],1)],1),e("div",{attrs:{slot:"footer"},slot:"footer"},[e("div",{staticClass:"text-left"},[e("van-button",{attrs:{icon:t.isFavorite?"like":"like-o",color:"#f48fb1",type:"default",plain:!t.isFavorite,size:"small"},on:{click:t.toggleFavorite}},[t._v(" "+t._s(t.isFavorite?"已收藏電影":"收藏電影")+" ")]),t.movieInfo.trailer?e("van-button",{staticClass:"margin-l-10",attrs:{type:"info",icon:"video-o",size:"small",plain:""},on:{click:t.watchTrailer}},[t._v(" 電影預告 ")]):t._e()],1)])],1):e("van-panel",[e("div",{staticClass:"padding-bt-10",attrs:{slot:"header"},slot:"header"},[e("van-skeleton",{attrs:{title:"",avatar:"","avatar-shape":"","avatar-size":"80",row:4}})],1)]),e("van-tabs",{staticClass:"margin-t-10",model:{value:t.cityId,callback:function(s){t.cityId=s},expression:"cityId"}},t._l(t.citys,function(s){return e("van-tab",{key:s.id,attrs:{title:s.name,name:s.id}})}),1),t._l(t.theaterList,function(s){return e("van-card",{key:s.id},[e("div",{staticClass:"flex-between",attrs:{slot:"title"},slot:"title"},[e("div",{staticClass:"fs-14",on:{click:function(o){return t.goTheater(s)}}},[t._v(" "+t._s(s.name)+" ")]),e("div",[e("van-button",{attrs:{type:"info",icon:"share",size:"mini",plain:""},on:{click:function(o){return t.share(s)}}},[t._v(" 分享 ")])],1)]),e("div",{attrs:{slot:"desc"},slot:"desc"},t._l(s.versions,function(o,n){return e("div",{key:n},[e("van-divider",{attrs:{"content-position":"left"}},[t._v(" "+t._s(o.name||"數位")+" ")]),t._l(o.times,function(l,c){return e("van-tag",{key:c,staticClass:"margin-a-5",attrs:{type:t.isExpired(l)?"default":"success",plain:""}},[t._v(" "+t._s(l)+" ")])})],2)}),0)])}),!t.theaterList.length&&!t.isEmpty?e("van-card",[e("van-skeleton",{attrs:{slot:"desc",title:"",row:3},slot:"desc"})],1):t._e()],2)},_=[],$=p(y,I,_,!1,null,null,null,null);const z=$.exports;export{z as default};
